# 2026-02-22 开发日志

## [代码质量] 全面审查与修复（22 个问题）

### Phase 1: 云函数安全加固

**修改文件**：`cloudfunctions/happiness/index.js`

- 新增 `sanitizeData()` 白名单函数，`createRecord` 和 `upsertRecord` 不再使用 `...data` 展开，防止客户端注入 `_openid` 等敏感字段
- 新增 `collection` 白名单校验（仅允许 `happiness_records`/`fortune_records`）
- 新增 `page`/`limit` 参数边界检查（limit 上限 50）

### Phase 2: Bug 修复

**修改文件**：
- `miniprogram/pages/home/index.js` — 去除重复 `getLocation` 调用；替换废弃 `wx.chooseImage` 为 `wx.chooseMedia`；修复随机回顾 `image_url` → `image_urls`
- `miniprogram/pages/home/index.wxml` — 修复 `location.name`（改为"已定位"）；随机弹窗改为 `image_urls` 数组展示
- `miniprogram/pages/random/index.js` + `index.wxml` — 同上
- `miniprogram/pages/record-detail/index.js` + `index.wxml` — 同上
- `miniprogram/components/editModal/index.js` — 替换 `wx.chooseImage`

### Phase 3: 代码去重与规范统一

**新增文件**：`miniprogram/utils/date.js` — 统一 `formatDate` 工具函数

**修改文件**：
- 5 个页面 JS 文件删除本地 `formatDate`，改用 `utils/date.js`
- `miniprogram/utils/cloud.js` — 新增 `uploadImageToCloud`/`uploadVoiceToCloud` 导出
- `miniprogram/pages/home/index.js` + `components/editModal/index.js` — 删除本地上传方法，改用 `utils/cloud.js`（修复规范违反）
- `miniprogram/utils/constants.js` — 新增 `CLOUD_FUNCTIONS.HAPPINESS`
- `miniprogram/services/happiness.js` + `fortune.js` — 硬编码 `'happiness'` 改为常量

### Phase 4: 错误处理与代码质量

**修改文件**：
- `miniprogram/utils/cloud.js` — 修复 `chooseAndUploadImage` 双重 loading；简化 `callFunction` resolve 逻辑并添加注释；简化 `checkCloudEnv`
- `miniprogram/pages/fortune/index.js` — 修复直接修改 `this.data.records`，改为路径式 `setData`
- `miniprogram/pages/record-detail/index.js` — `deleteRecord` 添加 `finally` 块
- `miniprogram/pages/home/index.js` — `loadRecords` 失败时清空首页数据

### Phase 5: 模板代码清理

**删除文件**：
- 模板页面：`pages/index/`、`pages/auth/`、`pages/database/`、`pages/storage/`、`pages/example/`
- 模板服务：`services/database.js`、`services/auth.js`
- 模板云函数：`cloudfunctions/quickstartFunctions/`、`cloudfunctions/auth/`、`cloudfunctions/database/`
- `envList.js`

**修改文件**：
- `app.json` — 移除模板页面注册
- `services/index.js` — 移除模板服务导出
- `utils/constants.js` — 清理模板相关常量
