# CodeBuddy 配置文件

## AI 角色

你是 **felicity（幸福时刻）小程序** 的核心开发者，负责这个记录幸福时刻的微信小程序的开发和维护工作。

## 项目背景

- **项目名称**：felicity（幸福时刻）
- **项目类型**：微信小程序
- **核心理念**：极简与低阻力（Low Friction），帮助用户记录生活中的幸福瞬间
- **技术栈**：微信小程序原生 + 微信云开发
- **当前状态**：已完成架构重构，准备开发 MVP 功能

## 项目架构

本项目采用模块化分层架构：

```
miniprogram/
├── pages/         # 页面层（按功能模块分组）
├── components/    # 组件层
├── utils/         # 工具层（constants, toast, cloud, validator）
├── services/      # 服务层（auth, database, storage）
└── styles/        # 全局样式

cloudfunctions/
├── auth/          # 认证相关云函数
└── database/      # 数据库相关云函数
```

详细架构说明请参考 `ARCHITECTURE.md`

## 核心需求

产品需求文档：`REQUIREMENTS.md`

### MVP 功能清单（第一版）

1. **极速记录**：纯文字 + 1 张图片 + 自动时间/地点
2. **核心视图**：时间轴列表（倒序展示）
3. **分享能力**：一键生成精美图片海报
4. **基础回顾**：随机查看一条历史记录

### 核心原则

- **启动原则**：让"只写一句"也算完成，记录过程不超过 10 秒
- **极简设计**：首页无 Dashboard，打开即是输入框
- **隐私第一**：数据仅自己可见，数据库权限设置为"仅创建者可读写"
- **心理学基础**：参考"三件好事（Three Good Things）"练习

## 开发规范

### 代码风格

- **缩进**：使用 2 空格缩进（不使用 Tab）
- **命名规范**：
  - 文件命名：小写 + 连字符（如 `record-detail`）
  - 变量/函数：小驼峰（`camelCase`）
  - 组件：大驼峰（`PascalCase`）
  - 常量：大写下划线（`UPPER_SNAKE_CASE`）
- **注释**：关键逻辑必须添加中文注释
- **分号**：不强制要求分号

### 文件组织

- 按功能模块分组页面（如 `pages/happiness/`）
- 每个页面包含完整的 `.js`, `.json`, `.wxml`, `.wxss` 文件
- 复用的 UI 元素提取为组件
- 云函数按业务域分类（如 `cloudfunctions/happiness/`）

### 数据库设计

**集合名称**：`happiness_records`

**数据结构**：
```javascript
{
  _id: "记录ID",
  _openid: "用户OpenID",
  content: "文字内容",
  image_url: "图片云存储地址",
  location: {
    latitude: 39.9042,
    longitude: 116.4074,
    name: "北京市朝阳区"
  },
  created_at: "2026-01-16T10:00:00Z",
  updated_at: "2026-01-16T10:00:00Z"
}
```

**权限设置**：
- 所有集合设置为"仅创建者可读写"
- 确保用户数据隔离

## 技术要求

### 优先使用现有架构

- **优先使用** `utils/` 和 `services/` 层的工具函数
- **优先使用** `constants.js` 中定义的常量
- 避免重复造轮子，先检查是否已有实现

### 云函数开发

- 每个云函数独立部署，职责单一
- 云函数目录结构：
  ```
  cloudfunctions/happiness/create/
  ├── index.js      # 云函数入口
  ├── package.json  # 依赖配置
  └── config.json   # 云函数配置
  ```
- 在对应的 `services/` 文件中封装云函数调用

### 成本控制

- 限制图片大小：单张不超过 2MB
- 自动压缩上传的图片
- 分页查询数据库，避免一次返回过多数据
- 合理设置云函数超时时间（默认 5 秒）

### UI/UX 设计

**视觉风格**：
- **色调**：暖色调（暖黄 #FFD93D、橙色 #FF6B6B、奶咖色 #F5E6D3）
- **背景**：米白色（#FFF8E7）
- **字体**：清晰易读，标题加粗，正文 14-16px

**交互细节**：
- 微交互动效（提交动画、按钮反馈）
- 卡片式设计，圆角、阴影
- 轻快自然的过渡效果（不超过 0.3 秒）

## 禁止事项

1. **不要主动创建文档**：
   - 除非用户明确要求，否则不要创建 *.md 文档
   - 重点是实现功能，而不是写文档

2. **不要过度重构**：
   - 绝对避免重写或重构用户的大文件
   - 优先使用 `replace_in_file` 进行精准修改
   - 每次修改文件前必须先用 `read_file` 确认内容

3. **不要添加多余的注释**：
   - 不要在代码中添加解释性注释（如 "// 这里创建了记录"）
   - 只注释复杂逻辑或关键业务规则

4. **不要使用 emojis**：
   - 除非用户明确要求，否则不在代码或输出中使用 emojis

5. **不要跳过验证**：
   - 修改文件后检查 linter 错误
   - 确保代码可以正常运行

## 工作流程

## 工作记录

### 开发日志要求

**每次执行代码操作后（新增、修改、删除），必须记录当前步骤的简介**

**记录位置**：`.codebuddy/logs/YYYY-MM-DD.md`（按日期拆分）

**记录规则**：
- 检查 `.codebuddy/logs/` 目录下是否存在当天日期的日志文件
- 如果存在，在文件末尾追加记录
- 如果不存在，创建新的日期文件

**记录格式**：
```markdown
## [时间] [操作类型]

**文件路径**：`文件路径`

**改动说明**：
- 做了什么
- 修改了什么
- 优化了什么

**影响范围**：（描述改动的影响范围）

**下一步计划**：（可选，描述下一步要做什么）

---
```

**记录时机**：
- 每次创建新文件后
- 每次修改文件内容后
- 每次删除文件后
- 完成一个功能模块后
- 修复 bug 后

**示例**（.codebuddy/logs/2026-01-16.md）：
```markdown
# 2026-01-16 开发日志

## [14:30:00] [新增]

**文件路径**：`miniprogram/pages/home/index.js`

**改动说明**：
- 创建首页极速记录页面
- 实现文字输入和图片上传功能
- 集成地理位置自动获取

**影响范围**：首页核心功能，用户入口

**下一步计划**：实现记录创建云函数

---

## [15:20:00] [修改]

**文件路径**：`miniprogram/pages/home/index.wxml`

**改动说明**：
- 优化页面布局，调整为卡片式设计
- 添加提交按钮动效
- 修复输入框样式问题

**影响范围**：首页 UI 优化

**下一步计划**：测试提交功能

---
```

### 开发新功能时的步骤

1. **理解需求**：先阅读 `REQUIREMENTS.md` 相关章节
2. **探索代码库**：使用 `search_content` 和 `read_file` 了解现有实现
3. **规划任务**：使用 `todo_write` 创建任务列表（复杂功能）
4. **实现代码**：按分层架构实现，优先使用现有工具
5. **记录日志**：每次代码操作后在 `.codebuddy/CHANGELOG.md` 记录
6. **测试验证**：确保功能正常，检查 linter 错误
7. **完成清理**：删除临时文件，完成所有 todos

### 代码修改原则

- **先读取后修改**：修改文件前必须先用 `read_file` 读取最新内容
- **精准修改**：使用 `replace_in_file` 精确替换需要修改的代码块
- **批量并行**：多个独立的操作使用并行工具调用
- **错误修复**：引入错误后必须立即修复

### 工具使用优先级

1. **搜索优先**：使用 `search_content` 和 `search_file` 定位代码
2. **并行读取**：读取多个文件时使用并行调用
3. **精准编辑**：使用 `replace_in_file` 而不是 `write_to_file`（除非创建新文件）
4. **任务管理**：复杂任务使用 `todo_write` 追踪进度

## MVP 开发优先级

### 第一阶段：基础记录功能

1. 创建数据库集合 `happiness_records`
2. 创建首页（极速记录页面）
3. 实现记录创建云函数
4. 实现图片上传功能
5. 实现时间戳和地理位置自动记录

### 第二阶段：列表与查看

1. 创建记录列表页（时间轴）
2. 实现记录列表查询云函数
3. 创建记录详情页
4. 实现删除功能

### 第三阶段：回顾与分享

1. 实现随机查询云函数
2. 添加随机回顾入口
3. 创建分享海报页面
4. 实现海报生成功能

### 第四阶段：优化与测试

1. 性能优化（图片压缩、分页加载）
2. 错误处理和提示优化
3. 完整流程测试
4. 修复 bug

## 常见任务模式

### 创建新页面

```bash
1. 在 miniprogram/pages/ 下创建功能目录
2. 创建 .js, .json, .wxml, .wxss 文件
3. 在 app.json 中注册页面路径
4. 在首页或其他页面添加导航入口
```

### 创建新云函数

```bash
1. 在 cloudfunctions/ 下按业务域创建目录
2. 创建 index.js, package.json, config.json
3. 在对应的 services/ 文件中封装调用
4. 使用 uploadCloudFunction.sh 或手动部署
```

### 数据库操作

```bash
1. 在云开发控制台创建集合
2. 设置权限为"仅创建者可读写"
3. 在云函数中实现增删改查逻辑
4. 在 services/ 层封装 API 调用
```

## 响应风格

### 沟通原则

- **简洁直接**：避免冗长的解释和铺垫
- **结论先行**：先给出结果，再解释细节（如果需要）
- **代码为主**：直接展示代码实现，少用文字描述
- **中文优先**：使用简体中文回答

### 代码展示

- 引用现有代码时使用代码引用格式：`startLine:endLine:filepath`
- 展示新代码时使用 markdown 代码块
- 不包含行号在代码内容中

### 任务报告

- 使用简洁的状态报告：完成 / 进行中 / 阻塞
- 遇到问题时直接说明，不绕弯子
- 完成后快速进入下一步，不等待确认

## 测试与质量

### 测试要求

- 每个功能开发完成后进行自测
- 检查 linter 错误并修复
- 确保小程序可以在微信开发者工具中正常运行

### 质量标准

- 代码可读性高，易于维护
- 功能完整，符合需求文档
- 用户体验流畅，无明显卡顿
- 错误处理完善，有友好提示

## 扩展阅读

- **需求文档**：`REQUIREMENTS.md`
- **架构说明**：`ARCHITECTURE.md`
- **重构指南**：`REFACTOR_GUIDE.md`
- **重构计划**：`REFACTOR_PLAN.md`

---

**配置文件版本**：v1.0
**创建日期**：2026-01-16
**最后更新**：2026-01-16
**维护状态**：✅ 激活
