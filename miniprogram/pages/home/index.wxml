<view class="container">
  <!-- é¡¶éƒ¨æ—¥æœŸ -->
  <view class="header">


    <text class="date">{{currentDate}}</text>
    <text class="greeting">ä»Šå¤©è®°å½•äº†å—ï¼Ÿ</text>
  </view>

  <!-- è®°å½•è¡¨å• -->
  <view class="form" style="min-height: {{formMinHeightPx}}px;">

    <!-- æ–‡å­—è¾“å…¥ + å·¥å…·æ  -->
    <view class="input-wrapper {{isInputFocused ? 'focused' : ''}}">
      <view class="input-box {{isInputFocused ? 'focused' : ''}}">
        <textarea
          class="content-input"
          placeholder="è®°å½•ä¸€ä¸ªå¼€å¿ƒçš„ç¬é—´..."
          placeholder-class="placeholder"
          value="{{content}}"
          bindinput="onContentInput"
          bindfocus="onInputFocus"
          bindblur="onInputBlur"
          maxlength="500"
          show-confirm-bar="{{false}}"
          fixed="{{true}}"
        />
        <view class="char-count">
          <text class="{{content.length > 400 ? 'warning' : ''}} {{content.length >= 500 ? 'error' : ''}}">{{content.length}}/500</text>
        </view>
      </view>

      <!-- åº•éƒ¨å·¥å…·æ  -->
      <view class="input-toolbar {{isInputFocused ? 'focused' : ''}}">
        <view class="toolbar-left">
          <!-- å›¾ç‰‡æŒ‰é’® -->
          <view
            class="tool-btn image-btn {{imageUrl ? 'has-image' : ''}}"
            bindtap="onChooseImage"
          >
            <view class="tool-icon-dot"></view>
            <text class="tool-label">å›¾ç‰‡</text>
          </view>

          <!-- è¯­éŸ³æŒ‰é’® -->
          <view
            class="tool-btn voice-btn {{isRecording ? 'recording' : ''}}"
            bindtouchstart="onVoiceStart"
            bindtouchend="onVoiceEnd"
            bindtouchcancel="onVoiceCancel"
          >
            <view class="tool-icon-dot"></view>
            <text class="tool-label">{{isRecording ? 'å½•éŸ³ä¸­' : 'è¯­éŸ³'}}</text>
          </view>

        </view>
      </view>
    </view>

    <!-- å½•éŸ³æç¤º -->
    <view class="recording-tip" wx:if="{{isRecording}}">
      <text>æ­£åœ¨å½•éŸ³ {{recordingTime}}sï¼Œæ¾å¼€ç»“æŸ</text>
    </view>

    <!-- å·²ä¸Šä¼ å½•éŸ³é¢„è§ˆ -->
    <view class="voice-preview" wx:if="{{voiceUrl}}">
      <view class="voice-info">
        <text class="voice-icon">ğŸ¤</text>
        <text class="voice-text">å·²å½•åˆ¶è¯­éŸ³</text>
      </view>
      <view class="voice-remove" bindtap="onRemoveVoice">
        <text>Ã—</text>
      </view>
    </view>

    <!-- å·²ä¸Šä¼ å›¾ç‰‡é¢„è§ˆ -->
    <view class="image-preview" wx:if="{{imageUrl}}">
      <image
        class="preview-image"
        src="{{imageUrl}}"
        mode="aspectFill"
      />
      <view class="image-remove" bindtap="onRemoveImage">
        <text>Ã—</text>
      </view>
    </view>

    <!-- ä½ç½®ä¿¡æ¯ -->
    <view class="location-group" wx:if="{{location}}">
      <text class="location-icon">ğŸ“</text>
      <text class="location-text">{{location.name || 'æœªçŸ¥ä½ç½®'}}</text>
    </view>

    <!-- æäº¤æŒ‰é’® -->
    <button
      class="submit-btn {{content || voiceUrl ? 'active' : ''}}"
      bindtap="onSubmit"
      disabled="{{!content && !voiceUrl || submitting}}"
      loading="{{submitting}}"
    >
      {{submitting ? 'è®°å½•ä¸­...' : 'ä¿å­˜å¹¸ç¦'}}
    </button>
  </view>

  <!-- å†å²è®°å½• -->
  <view class="records-section">
    <view class="section-header">
      <text class="section-title">å†å²è®°å½•</text>
      <text class="section-subtitle">ä¸‹æ‹‰æŸ¥çœ‹æ›´å¤š</text>
    </view>

    <view class="empty" wx:if="{{records.length === 0 && !loadingRecords}}">
      <text class="empty-text">è¿˜æ²¡æœ‰è®°å½•å“¦</text>
    </view>

    <view class="list" wx:if="{{records.length > 0}}">
      <view
        class="record-card"
        wx:for="{{records}}"
        wx:key="_id"
        bindtap="onCardTap"
        data-id="{{item._id}}"
      >
        <view class="card-header">
          <text class="card-time">{{item.created_at}}</text>
          <text class="card-location" wx:if="{{item.location && item.location.name}}">
            {{item.location.name}}
          </text>
        </view>

        <view class="card-content">
          <text class="content-text">{{item.content}}</text>
        </view>

        <view class="card-image" wx:if="{{item.image_url}}">
          <image
            src="{{item.image_url}}"
            mode="aspectFill"
            class="card-img"
          />
        </view>
      </view>
    </view>

    <view class="load-more" wx:if="{{hasMore && records.length > 0}}">
      <text>{{loadingRecords ? 'åŠ è½½ä¸­...' : 'ä¸Šæ‹‰åŠ è½½æ›´å¤š'}}</text>
    </view>

    <view class="footer-tip" wx:if="{{!hasMore && records.length > 0}}">
      <text>æ²¡æœ‰æ›´å¤šè®°å½•äº†</text>
    </view>
  </view>

  <!-- éšæœºå›é¡¾æ‚¬æµ®æŒ‰é’® -->
  <view class="random-fab" bindtap="openRandomModal">
    <text class="random-fab-text">éšæœºå›é¡¾</text>
  </view>

  <!-- éšæœºå›é¡¾å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showRandomModal}}" bindtap="closeRandomModal"></view>
  <view class="random-modal" wx:if="{{showRandomModal}}">
    <view class="random-modal-content" catchtap="noop">
      <view class="modal-header">
        <text class="modal-title">éšæœºå›é¡¾</text>
        <text class="modal-close" bindtap="closeRandomModal">Ã—</text>
      </view>

      <view class="modal-body" wx:if="{{randomLoading}}">
        <text class="modal-loading">åŠ è½½ä¸­...</text>
      </view>

      <view class="modal-body" wx:elif="{{randomRecord}}">
        <view class="random-card">
          <view class="card-header">
            <text class="card-badge">éšæœºå›å¿†</text>
            <text class="card-time">{{randomRecord.created_at}}</text>
          </view>

          <view class="card-content">
            <text class="content-text">{{randomRecord.content}}</text>
          </view>

          <view class="card-image" wx:if="{{randomRecord.image_url}}">
            <image
              src="{{randomRecord.image_url}}"
              mode="aspectFill"
              class="record-img"
              bindtap="onPreviewRandomImage"
            />
          </view>

          <view class="card-location" wx:if="{{randomRecord.location && randomRecord.location.name}}">
            <text class="location-label">ä½ç½®</text>
            <text class="location-text">{{randomRecord.location.name}}</text>
          </view>
        </view>
      </view>

      <view class="modal-body" wx:else>
        <text class="modal-empty">è¿˜æ²¡æœ‰è®°å½•å“¦</text>
      </view>

      <view class="modal-actions" wx:if="{{randomRecord}}">
        <button class="modal-btn primary" bindtap="onRefreshRandom">å†éšæœºä¸€æ¡</button>
        <button class="modal-btn ghost" bindtap="onViewRandomDetail">æŸ¥çœ‹è¯¦æƒ…</button>
      </view>
    </view>
  </view>
</view>

