<view class="container">
  <!-- 顶部日期 -->
  <view class="header">
    <text class="date">{{currentDate}}</text>
  </view>

  <!-- 记录表单 -->
  <view class="form" style="min-height: {{formMinHeightPx}}px;">
    <view class="cards">
      <view class="card-item" wx:for="{{cards}}" wx:for-item="card" wx:for-index="cardIndex" wx:key="localId">
        <view class="card-header">
          <text class="card-title">幸福时刻 {{cardIndex + 1}}</text>
          <view class="card-meta">
            <text class="card-status" wx:if="{{card.cloudId}}">已保存</text>
            <text class="card-delete" bindtap="onDeleteCard" data-index="{{cardIndex}}">删除</text>
          </view>
        </view>


        <view class="input-wrapper {{focusedCardIndex === cardIndex ? 'focused' : ''}}">
          <view class="input-box {{focusedCardIndex === cardIndex ? 'focused' : ''}}">
            <textarea
              class="content-input"
              placeholder="记录一个开心的瞬间..."
              placeholder-class="placeholder"
              value="{{card.content}}"
              bindinput="onCardContentInput"
              bindfocus="onInputFocus"
              bindblur="onInputBlur"
              data-index="{{cardIndex}}"
              maxlength="-1"
              show-confirm-bar="{{false}}"
              fixed="{{true}}"
              auto-height
            />
            <view class="char-count">
              <text>{{card.content.length}}</text>
            </view>
          </view>

          <view class="input-toolbar {{focusedCardIndex === cardIndex ? 'focused' : ''}}">
            <view class="toolbar-left">
              <view
                class="tool-btn image-btn {{card.imageUrls.length ? 'has-image' : ''}}"
                bindtap="onChooseImage"
                data-index="{{cardIndex}}"
              >
                <view class="tool-icon-dot"></view>
                <text class="tool-label">图片</text>
              </view>

              <view
                class="tool-btn voice-btn {{isRecording && recordingCardIndex === cardIndex ? 'recording' : ''}}"
                bindtap="onVoiceToggle"
                data-index="{{cardIndex}}"
              >
                <view class="tool-icon-dot"></view>
                <text class="tool-label">{{isRecording && recordingCardIndex === cardIndex ? '停止录音' : '语音'}}</text>
              </view>
            </view>
            <button
              class="submit-btn {{(card.content || card.voiceUrls.length || card.imageUrls.length) ? 'active' : ''}}"
              bindtap="onSaveCard"
              data-index="{{cardIndex}}"
              size="mini"
              disabled="{{!(card.content || card.voiceUrls.length || card.imageUrls.length) || submitting}}"
              loading="{{submitting}}"
            >
              {{submitting ? '保存中...' : '保存'}}
            </button>
          </view>
        </view>


        <view class="recording-tip" wx:if="{{isRecording && recordingCardIndex === cardIndex}}">
          <text>正在录音 {{recordingTime}}s，点击停止</text>
        </view>

        <view class="voice-preview" wx:if="{{card.voiceUrls.length}}">
          <view class="voice-item" wx:for="{{card.voiceUrls}}" wx:for-item="voice" wx:for-index="voiceIndex" wx:key="voiceIndex">
            <view class="voice-play-area" bindtap="onPlayVoice" data-index="{{cardIndex}}" data-voice-index="{{voiceIndex}}">
              <text class="voice-play-icon">{{playingVoiceKey === 'card-' + cardIndex + '-' + voiceIndex ? '⏸' : '▶'}}</text>
              <text class="voice-text">语音 {{voiceIndex + 1}}</text>
            </view>
            <text class="voice-remove" bindtap="onRemoveVoice" data-index="{{cardIndex}}" data-voice-index="{{voiceIndex}}">×</text>
          </view>
        </view>

        <view class="image-preview" wx:if="{{card.imageUrls.length}}">
          <view class="image-item" wx:for="{{card.imageUrls}}" wx:for-item="image" wx:for-index="imageIndex" wx:key="imageIndex">
            <image class="preview-image" src="{{image}}" mode="aspectFill" bindtap="onPreviewImage" data-index="{{cardIndex}}" data-url="{{image}}" />
            <text class="image-remove" bindtap="onRemoveImage" data-index="{{cardIndex}}" data-image-index="{{imageIndex}}">×</text>
          </view>
        </view>


        <view class="location-group" wx:if="{{location}}">
          <text class="location-text">已定位</text>
        </view>

      </view>
    </view>

    <view class="add-card" bindtap="onAddCard">
      <text class="add-card-text">+ 添加一条</text>
    </view>
  </view>

  <!-- 历史记录 -->
  <view class="records-section">
    <view class="section-header">
      <text class="section-title">历史记录</text>
      <text class="section-subtitle">下拉查看更多</text>
    </view>

    <view class="empty" wx:if="{{records.length === 0 && !loadingRecords}}">
      <text class="empty-text">还没有记录哦</text>
    </view>

    <view class="list" wx:if="{{records.length > 0}}">
      <view
        class="record-card"
        wx:for="{{records}}"
        wx:key="_id"
      >
        <view class="card-header">
          <text class="card-time">{{item.created_at}}</text>
          <view class="card-header-right">
            <text class="card-location" wx:if="{{item.location}}">
              已定位
            </text>
            <view class="more-btn" catchtap="onRecordAction" data-index="{{index}}">
              <text class="more-dots">···</text>
            </view>
          </view>
        </view>

        <view class="card-content">
          <view class="content-text-wrap {{item._needCollapse && !item._expanded ? 'collapsed' : ''}}">
            <text class="content-text">{{item.content}}</text>
          </view>
          <view class="expand-btn" wx:if="{{item._needCollapse && !item._expanded}}" catchtap="toggleExpand" data-index="{{index}}">
            <text class="expand-text">展开</text>
          </view>
          <view class="expand-btn" wx:if="{{item._needCollapse && item._expanded}}" catchtap="toggleExpand" data-index="{{index}}">
            <text class="expand-text">收起</text>
          </view>
        </view>

        <view class="record-voice-list" wx:if="{{item.voice_urls.length}}">
          <view class="record-voice-item" wx:for="{{item.voice_urls}}" wx:for-item="voiceUrl" wx:for-index="voiceIdx" wx:key="voiceIdx"
            bindtap="onPlayRecordVoice" data-record-index="{{index}}" data-voice-index="{{voiceIdx}}">
            <text class="voice-play-icon">{{playingVoiceKey === 'record-' + index + '-' + voiceIdx ? '⏸' : '▶'}}</text>
            <text class="voice-text">语音 {{voiceIdx + 1}}</text>
          </view>
        </view>

        <view class="card-images" wx:if="{{item.image_urls.length}}">
          <image
            wx:for="{{item.image_urls}}"
            wx:for-item="imgUrl"
            wx:key="*this"
            src="{{imgUrl}}"
            mode="aspectFill"
            class="card-img"
          />
        </view>
      </view>
    </view>

    <view class="load-more" wx:if="{{hasMore && records.length > 0}}">
      <text>{{loadingRecords ? '加载中...' : '上拉加载更多'}}</text>
    </view>

    <view class="footer-tip" wx:if="{{!hasMore && records.length > 0}}">
      <text>没有更多记录了</text>
    </view>
  </view>

  <!-- 操作弹窗 -->
  <view class="popup-mask" wx:if="{{actionPopup.visible}}" catchtap="closeActionPopup"></view>
  <view
    class="action-popup"
    wx:if="{{actionPopup.visible}}"
    style="top: {{actionPopup.y}}px; right: {{actionPopup.right}}px;"
    catchtap="noop"
  >
    <view class="popup-item" catchtap="onPopupEdit">
      <text class="popup-item-text">编辑</text>
    </view>
    <view class="popup-item" catchtap="onPopupCopy">
      <text class="popup-item-text">复制</text>
    </view>
    <view class="popup-divider"></view>
    <view class="popup-item" catchtap="onPopupDelete">
      <text class="popup-item-text delete">删除</text>
    </view>
  </view>

  <!-- 随机回顾悬浮按钮 -->
  <view class="random-fab" bindtap="openRandomModal">
    <text class="random-fab-text">随机回顾</text>
  </view>

  <!-- 随机回顾弹窗 -->
  <view class="modal-mask" wx:if="{{showRandomModal}}" bindtap="closeRandomModal"></view>
  <view class="random-modal" wx:if="{{showRandomModal}}">
    <view class="random-modal-content" catchtap="noop">
      <view class="modal-header">
        <text class="modal-title">随机回顾</text>
        <text class="modal-close" bindtap="closeRandomModal">×</text>
      </view>

      <view class="modal-body" wx:if="{{randomLoading}}">
        <text class="modal-loading">加载中...</text>
      </view>

      <view class="modal-body" wx:elif="{{randomRecord}}">
        <view class="random-card">
          <view class="card-header">
            <text class="card-badge">随机回忆</text>
            <text class="card-time">{{randomRecord.created_at}}</text>
          </view>

          <view class="card-content">
            <text class="content-text">{{randomRecord.content}}</text>
          </view>

          <view class="card-images" wx:if="{{randomRecord.image_urls.length}}">
            <image
              wx:for="{{randomRecord.image_urls}}"
              wx:key="*this"
              src="{{item}}"
              mode="aspectFill"
              class="record-img"
              bindtap="onPreviewRandomImage"
              data-url="{{item}}"
            />
          </view>

          <view class="card-location" wx:if="{{randomRecord.location}}">
            <text class="location-label">位置</text>
            <text class="location-text">已定位</text>
          </view>
        </view>
      </view>

      <view class="modal-body" wx:else>
        <text class="modal-empty">还没有记录哦</text>
      </view>

      <view class="modal-actions" wx:if="{{randomRecord}}">
        <button class="modal-btn primary" bindtap="onRefreshRandom">再随机一条</button>
        <button class="modal-btn ghost" bindtap="onViewRandomDetail">查看详情</button>
      </view>
    </view>
  </view>

  <!-- 编辑弹窗 -->
  <edit-modal
    visible="{{editModalVisible}}"
    record="{{editModalRecord}}"
    bind:save="onEditSave"
    bind:close="onEditClose"
  />
</view>
